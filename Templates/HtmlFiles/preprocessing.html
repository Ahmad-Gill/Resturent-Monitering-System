{% extends "HtmlFiles/Base.html" %}

{% block title %}Preprocessing{% endblock %}
{% block home_active %}active{% endblock %}

{% load static %}
{% block body %}
<link href="{% static 'CssFiles/Add_Video.css' %}" rel="stylesheet">
<link href="{% static 'CssFiles/variables.css' %}" rel="stylesheet">

<div class="container_">
    <h1>Preprocessing Step 1</h1>
    <p style="margin: 20px 0; line-height: 1.6;">
        Select grids from the image to define the table area. Click on a grid to select it (turns green). Hover over selected grids to highlight them in red. 
        Ensure all necessary grids are selected, then click <strong>"Submit Grids"</strong> to proceed.
    </p>
    

    <!-- Buttons Container -->
    <div class="flex-row">
        <!-- Get Frame Button -->
        <form method="POST" enctype="multipart/form-data" action="{% url 'preprocessing' %}">
            {% csrf_token %}
            <button type="submit" class="submit-btn" id="startBtn">Get Frame</button>
        </form>

        <!-- Submit Grids Button -->
        <div id="submitSection">
            <button id="submitGridsBtn">Submit Grids</button>
        </div>
    </div>

    <!-- Display Frame -->
    {% if frame_rgb %}
    <h2>Extracted Frame with Grids:</h2>

    <!-- Display Frame with Grid Overlay -->
    <div id="imageContainer" style="position: relative; display: inline-block;">
        <img src="data:image/png;base64,{{ frame_rgb }}" alt="Frame with grid" style="max-width: 100%; height: auto;" />
        <!-- Overlay Div for Grid Selection -->
        <div id="gridOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
    </div>
    <br><br>
    <!-- Grid Input Section -->
    <div id="gridInputSection">
        <!-- Already included above for Submit Grids -->
    </div>
    {% else %}
    <p>No frame available to display.</p>
    {% endif %}
</div>


<!-- Lottie Animation for loading (optional) -->
<div id="overlay" class="overlay">
    <div id="lottie-animation" data-animation-path="{% static 'Animation/Animation1.json' %}" style="width: 50vw; height: auto; margin: 0 auto;"></div>
</div>

<!-- Include Lottie JS from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.4/lottie.min.js"></script>
{% comment %} <script src="{% static 'JavaScriptFiles/preprocessing.js' %}"></script> {% endcomment %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const gridOverlay = document.getElementById("gridOverlay");
        const gridNumbers = []; // Array to hold the selected grid numbers
        const gridList = document.getElementById("gridList");
        const submitGridsBtn = document.getElementById("submitGridsBtn");
        const overlay = document.getElementById("overlay"); // Loading overlay
        const rows = 20;
        const cols = 20;
    
        // Generate 20x20 grids
        for (let row = 0; row < rows; row++) {
            for (let col = 0; col < cols; col++) {
                const gridCell = document.createElement("div");
                gridCell.style.position = "absolute";
                gridCell.style.border = "1px solid rgba(0, 0, 0, 0.5)";
                gridCell.style.width = `${100 / cols}%`;
                gridCell.style.height = `${100 / rows}%`;
                gridCell.style.top = `${(row * 100) / rows}%`;
                gridCell.style.left = `${(col * 100) / cols}%`;
                gridCell.style.boxSizing = "border-box";
                gridCell.setAttribute("data-grid", `${row * cols + col + 1}`);
                gridCell.style.cursor = "pointer";
                gridCell.style.pointerEvents = "auto";
    
                // Hover Effect
                gridCell.addEventListener("mouseenter", () => {
                    if (gridNumbers.includes(gridCell.getAttribute("data-grid"))) {
                        gridCell.style.backgroundColor = "rgba(255, 0, 0, 0.5)"; // Red if already selected
                    } else {
                        gridCell.style.backgroundColor = "rgba(255, 255, 0, 0.5)"; // Yellow on hover
                    }
                });
                gridCell.addEventListener("mouseleave", () => {
                    if (gridNumbers.includes(gridCell.getAttribute("data-grid"))) {
                        gridCell.style.backgroundColor = "rgba(0, 255, 0, 0.5)"; // Green if selected
                    } else {
                        gridCell.style.backgroundColor = "transparent"; // Transparent if not selected
                    }
                });
    
                // Click to Select/Unselect
                gridCell.addEventListener("click", () => {
                    const gridNumber = gridCell.getAttribute("data-grid");
                    if (!gridNumbers.includes(gridNumber)) {
                        gridNumbers.push(gridNumber);
                        gridCell.style.backgroundColor = "rgba(0, 255, 0, 0.5)"; // Green for selected
                    } else {
                        gridNumbers.splice(gridNumbers.indexOf(gridNumber), 1);
                        gridCell.style.backgroundColor = "transparent"; // Unselected
                    }
                    displayGrids();
                });
    
                gridOverlay.appendChild(gridCell);
            }
        }
    
        // Display selected grids
        function displayGrids() {
            gridList.innerHTML = ''; // Clear the list
            gridNumbers.forEach((grid, index) => {
                const listItem = document.createElement("li");
                listItem.textContent = `Grid ${grid}`;
                listItem.style.marginBottom = '10px';
                gridList.appendChild(listItem);
            });
        }
    
        // Submit grids via AJAX
        submitGridsBtn.addEventListener("click", function () {
            if (gridNumbers.length === 0) {
                alert("No grids to submit. Please select grids before submitting.");
                return;
            }
    
            sendGridsToServer(gridNumbers);
        });
    
        // Send grids to the server
        function sendGridsToServer(grids) {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
            // Show loading overlay
            overlay.style.display = 'block';
    
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/preprocessing_1", true);
            xhr.setRequestHeader("X-CSRFToken", csrfToken);
            xhr.setRequestHeader("Content-Type", "application/json");
    
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    overlay.style.display = 'none'; // Hide overlay
                    if (xhr.status === 200) {
                        alert("Grids submitted successfully!");
                        window.location.href = '/preprocessing_1';
                        gridNumbers.length = 0; // Clear selected grids
                        displayGrids();
                    } else {
                        alert("Error submitting grids.");
                    }
                }
            };
    
            xhr.send(JSON.stringify({ grids })); // Send grid data
        }
    });
    
</script>


{% endblock %}
